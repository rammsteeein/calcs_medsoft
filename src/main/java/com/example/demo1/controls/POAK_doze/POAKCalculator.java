package com.example.demo1.controls.POAK_doze;

public class POAKCalculator {

    /**
     * Калькулятор доз пероральных антикоагулянтов (ПОАК):
     * дабигатрана, ривароксабана и апиксабана.
     *
     * Алгоритм подбирает дозу в зависимости от:
     *  - клиренса креатинина (КлКр, мл/мин)
     *  - возраста пациента
     *  - массы тела
     *  - наличия повышенного риска кровотечения
     *
     * ---------------------------------------------------------------------
     * ДАБИГАТРАН:
     * ---------------------------------------------------------------------
     * Основа: стандартная доза — 150 мг 2 раза в день.
     *
     * 1. Если КлКр < 30 мл/мин -> препарат противопоказан.
     * 2. Если КлКр 30–50 мл/мин и возраст > 80 -> 110 мг 2 раза в день.
     * 3. Если КлКр 30–50 мл/мин и возраст 75–80 -> 150 мг 2 раза в день,
     *    однако допускается снижение до 110 мг 2 раза в день по решению врача.
     * 4. Если КлКр > 50 мл/мин -> 150 мг 2 раза в день.
     * 5. При высоком риске кровотечения — рассмотреть дозу 110 мг 2 раза в день.
     *
     * ---------------------------------------------------------------------
     * РИВАРОКСАБАН:
     * ---------------------------------------------------------------------
     * Стандартная доза — 20 мг 1 раз в день (приём с пищей).
     *
     * 1. Если КлКр ≥ 50 мл/мин -> 20 мг 1 раз в день.
     * 2. Если КлКр 15–49 мл/мин -> 15 мг 1 раз в день.
     * 3. Если КлКр < 15 мл/мин -> противопоказан.
     * 4. При высоком риске кровотечения — обсудить снижение дозы до 15 мг.
     *
     * ---------------------------------------------------------------------
     * АПИКСАБАН:
     * ---------------------------------------------------------------------
     * Стандартная доза — 5 мг 2 раза в день.
     *
     * Дозу снижают до 2.5 мг 2 раза в день, если присутствуют хотя бы
     * ДВА из трёх критериев:
     *   - возраст ≥ 80 лет
     *   - масса ≤ 60 кг
     *   - креатинин ≥ 133 мкмоль/л
     *
     * 1. Если КлКр < 15 мл/мин -> препарат противопоказан.
     * 2. При умеренной почечной недостаточности (КлКр 15–29) —
     *    с осторожностью, дозу подбирать индивидуально.
     * 3. При высоком риске кровотечения — рассмотреть дозу 2.5 мг 2 раза в день.
     *
     * ---------------------------------------------------------------------
     * ВЫВОД:
     * ---------------------------------------------------------------------
     * Метод возвращает строку с рекомендацией:
     *   - основной дозой
     *   - уточнениями (например, "по решению врача возможно снижение дозы")
     *   - предупреждениями ("противопоказан при данном клиренсе")
     */

    public static String calc(
            String drug,
            double clearance,
            Integer age,
            Double weight,
            Double creatinine,
            boolean hasBleedingRisk
    ) {
        if (drug == null || drug.isBlank()) {
            return "Выберите препарат";
        }

        switch (drug.toLowerCase()) {
            case "дабигатран":
                return calcDabigatran(clearance, age, hasBleedingRisk);

            case "апиксабан":
                return calcApixaban(clearance, age, weight, creatinine);

            case "ривароксабан":
                return calcRivaroxaban(clearance);

            default:
                return "Неизвестный препарат";
        }
    }

    private static String calcDabigatran(double clearance, int age, boolean hasBleedingRisk) {
        StringBuilder sb = new StringBuilder("Рекомендация: ");

        if (clearance < 30) {
            sb.append("Противопоказан при клиренсе < 30 мл/мин");
            return sb.toString();
        }

        if (clearance >= 30 && clearance <= 50) {
            if (age > 80) {
                sb.append("110 мг 2 раза в день");
            } else if (age >= 75 && age <= 80 || hasBleedingRisk) {
                sb.append("150 мг 2 раза в день (по усмотрению врача возможно снижение до 110 мг)");
            } else {
                sb.append("150 мг 2 раза в день");
            }
            return sb.toString();
        }

        if (clearance > 50) {
            if (age > 80) {
                sb.append("110 мг 2 раза в день");
            } else if (age >= 75 && age <= 80 || hasBleedingRisk) {
                sb.append("150 мг 2 раза в день (по усмотрению врача возможно снижение до 110 мг)");
            } else {
                sb.append("150 мг 2 раза в день");
            }
            return sb.toString();
        }

        return "Недостаточно данных";
    }

    private static String calcApixaban(double clearance, int age, Double weight, Double creatinine) {
        StringBuilder sb = new StringBuilder("Рекомендация: ");

        if (clearance < 15) {
            sb.append("Противопоказан при клиренсе < 15 мл/мин");
            return sb.toString();
        }

        if (clearance >= 15 && clearance <= 29) {
            sb.append("2.5 мг 2 раза в день (применять с осторожностью)");
            return sb.toString();
        }

        // ≥30 мл/мин
        int criteriaCount = 0;
        if (age >= 80) criteriaCount++;
        if (weight != null && weight <= 60) criteriaCount++;
        if (creatinine != null && creatinine >= 133) criteriaCount++;

        if (criteriaCount >= 2) {
            sb.append("2.5 мг 2 раза в день");
        } else {
            sb.append("5 мг 2 раза в день");
        }

        return sb.toString();
    }

    private static String calcRivaroxaban(double clearance) {
        if (clearance < 15) {
            return "Противопоказан при клиренсе < 15 мл/мин";
        }
        if (clearance >= 15 && clearance < 49) {
            return "15 мг 1 раз в день";
        }
        return "20 мг 1 раз в день";
    }
}